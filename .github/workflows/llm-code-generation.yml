name: LLM Code Generation

# Workflow for automated code generation using Claude Code GitHub Actions
# Accepts a prompt input, generates code via Claude Code, creates a branch, commits code, and opens a PR
# Reference: https://code.claude.com/docs/en/github-actions

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: 'Code generation prompt'
        required: true
        type: string
      base_branch:
        description: "Base branch for PR"
        required: false
        default: "main"
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write  # Required for AWS Bedrock/Google Vertex AI OIDC authentication
  actions: read    # Required for Claude to read CI results on PRs

jobs:
  generate-code:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 1
          persist-credentials: true

      - name: Configure git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create work branch
        id: branch
        run: |
          BRANCH="claude/${{ github.run_id }}-${{ github.run_attempt }}"
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"
          git checkout -b "$BRANCH"

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          prompt: ${{ inputs.prompt }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: |
            --model claude-sonnet-4-5-20250929
            --max-turns 25
            --allowedTools "Write,Bash(ls),Bash(pwd),Bash(cat),Bash(grep),Bash(rg),Bash(find),Bash(test)"
            --dangerously-skip-permissions

      - name: Commit changes (if any)
        id: commit
        run: |
          if git diff --quiet && git diff --cached --quiet; then
            echo "no_changes=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          git add -A
          git commit -m "chore: apply Claude changes"
          echo "no_changes=false" >> "$GITHUB_OUTPUT"

      # Important: Claude action can alter git auth/credential state in CI
      # Re-wire origin to use the workflow GITHUB_TOKEN before pushing
      - name: Re-authenticate git for push
        if: steps.commit.outputs.no_changes != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"

      - name: Push branch
        if: steps.commit.outputs.no_changes != 'true'
        run: |
          git push --set-upstream origin "${{ steps.branch.outputs.branch }}"

      - name: Create PR
        if: steps.commit.outputs.no_changes != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --base "${{ inputs.base_branch }}" \
            --head "${{ steps.branch.outputs.branch }}" \
            --title "Claude changes: ${{ github.run_id }}" \
            --body "${{ inputs.prompt }}"
